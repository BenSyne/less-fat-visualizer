<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DirectMed | GLPâ€‘1 Weight Loss Preview</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .image-circle {
      border-radius: 50%;
      overflow: hidden;
      border: 6px solid white;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .upload-area {
      transition: all 0.3s ease;
    }
    
    .upload-area:hover {
      transform: scale(1.02);
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loader {
      border: 4px solid #E5E7EB;
      border-top-color: #667eea;
      border-radius: 50%;
      width: 64px;
      height: 64px;
      animation: spin 0.8s linear infinite;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #0ea5e9 0%, #7c3aed 100%);
    }
    .blur-animate { transition: filter 900ms ease, opacity 400ms ease; }
    .blur-20 { filter: blur(18px); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur shadow">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-8 h-8 rounded-lg gradient-bg"></div>
        <div class="text-lg md:text-xl font-bold text-gray-900">DirectMed</div>
      </div>
      <a href="#uploadSection" class="hidden md:inline-block gradient-bg text-white px-5 py-2 rounded-full font-semibold shadow-md hover:shadow-lg">Start Free Preview</a>
    </div>
  </header>
  
  <!-- Landing/Upload Section -->
  <div id="uploadSection" class="container mx-auto px-4 py-16 max-w-6xl">
    <div class="text-center mb-10">
      <p class="uppercase tracking-widest text-sm font-semibold text-indigo-600 mb-2">DirectMed GLPâ€‘1 Program</p>
      <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 mb-4 leading-tight">See Your Future Self â€” Thinner, Fitter, Healthier</h1>
      <p class="text-lg text-gray-600">FDAâ€‘approved GLPâ€‘1 care with boardâ€‘certified clinicians, delivered via telehealth.</p>
    </div>
    
    <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-8 border border-gray-100">
      <div id="uploadArea" 
           class="upload-area border-3 border-dashed border-gray-300 rounded-xl bg-gray-50 p-8 sm:p-12 md:p-16 text-center cursor-pointer">
        <input type="file" id="photoInput" accept="image/jpeg,image/png,image/webp" class="hidden">
        <div id="uploadPrompt">
          <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <p class="text-xl font-semibold text-gray-700 mb-2">ðŸ“¸ Drag & drop a photo to preview your GLPâ€‘1 results</p>
          <p class="text-gray-500 mb-4">or click to browse files</p>
          <p class="text-sm text-gray-400">Supports: JPEG, PNG, WebP (10MB max) â€¢ Private: image stays on your device</p>
        </div>
        <div id="uploadPreview" class="hidden">
          <div id="inlineGrid" class="mx-auto mb-4 grid grid-cols-1 md:grid-cols-2 gap-6 items-center justify-items-center">
            <div class="image-circle w-64 h-64">
              <img id="previewImage" src="" alt="Preview" class="w-full h-full object-cover">
            </div>
            <div class="image-circle w-64 h-64 relative hidden" id="inlineResultContainer">
              <img id="inlineAfterImage" src="" alt="Processing" class="w-full h-full object-cover blur-animate blur-20">
              <div id="inlineProcessingOverlay" class="absolute inset-0 flex items-center justify-center text-center bg-white/60 backdrop-blur-sm rounded-full px-4">
                <div>
                  <div class="loader mx-auto mb-4"></div>
                  <p id="inlineOverlayText" class="text-sm text-gray-700">Preparing your AI weight loss transformationâ€¦</p>
                </div>
              </div>
            </div>
          </div>
          <p id="uploadMsg" class="text-lg font-medium text-gray-700 mb-4">Photo uploaded! When ready, weâ€™ll reveal the new you â†’</p>
          <div class="flex flex-wrap justify-center items-center gap-3 md:gap-4 mt-2">
            <button id="transformBtn" class="gradient-bg text-white inline-flex items-center gap-2 px-6 md:px-8 py-3 rounded-full font-semibold text-base md:text-lg shadow-md hover:shadow-lg active:scale-[.98] transition">
              <span>See Your Transformation</span>
              <span aria-hidden>â†’</span>
            </button>
            <span id="inlineActions" class="hidden inline-flex flex-wrap gap-3 md:gap-4">
              <button id="downloadBtnInline" class="inline-flex items-center gap-2 px-6 md:px-7 py-3 rounded-full font-semibold text-base md:text-lg shadow-sm hover:shadow-md active:scale-[.98] transition text-white gradient-bg">
                <span>â¬‡</span><span>Download</span>
              </button>
              <button id="tryAgainBtnInline" class="inline-flex items-center gap-2 px-6 md:px-7 py-3 rounded-full font-semibold text-base md:text-lg border-2 border-purple-600 text-purple-600 bg-white hover:bg-purple-50 active:scale-[.98] transition">
                <span>ðŸ“¸</span><span>Try Another</span>
              </button>
            </span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="grid md:grid-cols-3 gap-6 text-center">
      <div class="bg-white rounded-lg p-6 shadow-md border border-gray-100">
        <div class="text-3xl mb-2">âš¡</div>
        <p class="font-semibold text-gray-800">Fast visual preview</p>
        <p class="text-sm text-gray-500">See yourself slimmer in ~60 seconds</p>
      </div>
      <div class="bg-white rounded-lg p-6 shadow-md border border-gray-100">
        <div class="text-3xl mb-2">ðŸ©º</div>
        <p class="font-semibold text-gray-800">Clinicianâ€‘guided GLPâ€‘1</p>
        <p class="text-sm text-gray-500">Boardâ€‘certified providers with ongoing care</p>
      </div>
      <div class="bg-white rounded-lg p-6 shadow-md border border-gray-100">
        <div class="text-3xl mb-2">ðŸ”’</div>
        <p class="font-semibold text-gray-800">Private by design</p>
        <p class="text-sm text-gray-500">Memoryâ€‘only processing, HIPAAâ€‘grade standards</p>
      </div>
    </div>
  </div>
  
  <!-- Processing Section -->
  <div id="processingSection" class="hidden container mx-auto px-4 py-16 max-w-4xl">
    <div class="text-center">
      <h2 class="text-3xl font-bold text-gray-900 mb-8">Creating Your Transformation...</h2>
      <div class="loader mx-auto mb-6"></div>
      <div class="max-w-md mx-auto mb-6">
        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
          <div id="progressBar" class="h-full gradient-bg transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
      <p id="statusText" class="text-lg text-gray-600 mb-2">Analyzing your photo...</p>
      <p class="text-sm text-gray-500">Estimated time: <span id="timeRemaining">60</span> seconds</p>
    </div>
  </div>
  
  <!-- Results Section -->
  <div id="resultsSection" class="hidden container mx-auto px-4 py-16 max-w-6xl">
    <div class="text-center mb-12">
      <h2 class="text-4xl font-bold text-gray-900 mb-2">Your Transformation is Ready! ðŸŽ‰</h2>
      <p class="text-gray-600">Here's what you could look like 20% lighter</p>
    </div>
    
    <div class="grid md:grid-cols-2 gap-12 mb-12">
      <!-- Before -->
      <div class="text-center">
        <div class="image-circle w-64 h-64 sm:w-72 sm:h-72 md:w-80 md:h-80 mx-auto mb-6">
          <img id="beforeImage" src="" alt="Before: Original photo" class="w-full h-full object-cover">
        </div>
        <p class="text-xl font-semibold text-gray-700 uppercase tracking-wide">Today</p>
      </div>
      
      <!-- After -->
      <div class="text-center">
        <div class="image-circle w-64 h-64 sm:w-72 sm:h-72 md:w-80 md:h-80 mx-auto mb-6">
          <img id="afterImage" src="" alt="After: 20% lighter" class="w-full h-full object-cover">
        </div>
        <p class="text-xl font-semibold text-gray-700 uppercase tracking-wide">Your Future You</p>
        <p class="text-sm text-gray-500">(20% lighter)</p>
      </div>
    </div>
    
      <div class="flex flex-wrap justify-center items-center gap-3 md:gap-4">
        <button id="downloadBtn" class="gradient-bg text-white inline-flex items-center gap-2 px-6 md:px-8 py-3 rounded-full font-semibold text-base md:text-lg shadow-md hover:shadow-lg active:scale-[.98] transition">
          <span>â¬‡</span><span>Download Result</span>
        </button>
        <button id="tryAgainBtn" class="inline-flex items-center gap-2 px-6 md:px-8 py-3 rounded-full font-semibold text-base md:text-lg border-2 border-purple-600 text-purple-600 bg-white hover:bg-purple-50 active:scale-[.98] transition">
          <span>ðŸ“¸</span><span>Try Another Photo</span>
        </button>
      </div>
    
    <div class="mt-12 text-center max-w-3xl mx-auto">
      <div class="bg-white border border-gray-100 rounded-xl p-5 text-left">
        <p class="text-sm text-gray-600">DirectMed connects you with boardâ€‘certified clinicians for GLPâ€‘1 weightâ€‘loss care. This preview is for motivation, not diagnosis. Eligibility and medication are determined by a licensed provider. Results vary. See our informed consent and privacy policy for details.</p>
      </div>
    </div>
  </div>
  
  <!-- FAQ -->
  <section id="faq" class="container mx-auto px-4 py-16 max-w-4xl">
    <h3 class="text-3xl font-bold text-gray-900 text-center mb-8">Frequently Asked Questions</h3>
    <div class="space-y-4">
      <details class="bg-white rounded-lg border border-gray-200 p-4">
        <summary class="font-semibold cursor-pointer">Is my photo private?</summary>
        <p class="text-gray-600 mt-2">Yes. We process uploads in memory and return an image data URL to your browser. The client stores it in localStorage and we immediately clean up server memory.</p>
      </details>
      <details class="bg-white rounded-lg border border-gray-200 p-4">
        <summary class="font-semibold cursor-pointer">What medications are used?</summary>
        <p class="text-gray-600 mt-2">DirectMed clinicians prescribe FDAâ€‘approved GLPâ€‘1 medications when clinically appropriate. Your eligibility is determined during a telehealth visit.</p>
      </details>
      <details class="bg-white rounded-lg border border-gray-200 p-4">
        <summary class="font-semibold cursor-pointer">How accurate is the preview?</summary>
        <p class="text-gray-600 mt-2">Itâ€™s a motivational visualization, not a guarantee. It keeps your identity and scene unchanged and aims to show a realistic slimmer version of you.</p>
      </details>
    </div>
  </section>

  <!-- Footer -->
  <footer class="border-t border-gray-200 py-8">
    <div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row items-center justify-between text-sm text-gray-500">
      <div class="flex items-center space-x-2">
        <div class="w-7 h-7 rounded-lg gradient-bg"></div>
        <span>Â© <span id="year"></span> DirectMed. All rights reserved.</span>
      </div>
      <div class="space-x-4 mt-4 md:mt-0">
        <a href="#" class="hover:text-gray-700">Privacy</a>
        <a href="#" class="hover:text-gray-700">Terms</a>
        <a href="#faq" class="hover:text-gray-700">FAQ</a>
      </div>
    </div>
  </footer>

  <!-- Mobile sticky CTA -->
  <div class="fixed md:hidden bottom-0 inset-x-0 z-40 bg-white/95 backdrop-blur border-t border-gray-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="text-sm text-gray-700">Ready for real results with DirectMed?</div>
      <a href="#uploadSection" class="gradient-bg text-white px-4 py-2 rounded-full font-semibold shadow-md">Start Preview</a>
    </div>
  </div>
  
  <script>
    // State management
    let uploadedFile = null;
    let uploadedImageUrl = null;
    let jobId = null;
    let pollInterval = null;
    
    // API Configuration
    const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3000/api'
      : '/api';
    
    // Elements
    const uploadArea = document.getElementById('uploadArea');
    const photoInput = document.getElementById('photoInput');
    const uploadPrompt = document.getElementById('uploadPrompt');
    const uploadPreview = document.getElementById('uploadPreview');
    const previewImage = document.getElementById('previewImage');
    const transformBtn = document.getElementById('transformBtn');
    const uploadSection = document.getElementById('uploadSection');
    const processingSection = document.getElementById('processingSection');
    const resultsSection = document.getElementById('resultsSection');
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('statusText');
    const timeRemaining = document.getElementById('timeRemaining');
    const beforeImage = document.getElementById('beforeImage');
    const afterImage = document.getElementById('afterImage');
    const downloadBtn = document.getElementById('downloadBtn');
    const tryAgainBtn = document.getElementById('tryAgainBtn');
    const yearEl = document.getElementById('year');
    if (yearEl) yearEl.textContent = new Date().getFullYear();
    const inlineResultContainer = document.getElementById('inlineResultContainer');
    const inlineAfterImage = document.getElementById('inlineAfterImage');
    const inlineProcessingOverlay = document.getElementById('inlineProcessingOverlay');
    const inlineOverlayText = document.getElementById('inlineOverlayText');
    const inlineActions = document.getElementById('inlineActions');
    const downloadBtnInline = document.getElementById('downloadBtnInline');
    const tryAgainBtnInline = document.getElementById('tryAgainBtnInline');
    
    // Upload area click
    uploadArea.addEventListener('click', () => {
      if (!uploadedFile) photoInput.click();
    });
    
    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('border-purple-500', 'bg-purple-50');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('border-purple-500', 'bg-purple-50');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('border-purple-500', 'bg-purple-50');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        handleFileUpload(file);
      }
    });
    
    // File input change
    photoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleFileUpload(file);
    });
    
    // Handle file upload
    function handleFileUpload(file) {
      uploadedFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        uploadedImageUrl = e.target.result;
        previewImage.src = uploadedImageUrl;
        uploadPrompt.classList.add('hidden');
        uploadPreview.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
    
    // Transform button
    transformBtn.addEventListener('click', async () => {
      if (!uploadedFile) return;
      
      // Inline processing animation: show second circle next to original
      const msg = document.getElementById('uploadMsg');
      if (msg) msg.textContent = 'Preparing your transformationâ€¦';
      inlineResultContainer.classList.remove('hidden');
      inlineAfterImage.src = uploadedImageUrl; // start with blurred copy of original
      inlineAfterImage.classList.add('blur-20');
      inlineProcessingOverlay.classList.remove('hidden');
      if (inlineOverlayText) inlineOverlayText.textContent = 'Preparing your AI weight loss transformationâ€¦';
      
      // Start transformation
      await startTransformation();
    });
    
    // Start transformation (API call)
    async function startTransformation() {
      try {
        // Upload image first
        const formData = new FormData();
        formData.append('photo', uploadedFile);
        
        const uploadResponse = await fetch(`${API_BASE_URL}/upload-photo`, {
          method: 'POST',
          body: formData
        });
        
        const uploadData = await uploadResponse.json();
        
        // Start transformation job
        const transformResponse = await fetch(`${API_BASE_URL}/transform`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            imageId: uploadData.imageId,
            transformationType: 'weight-loss',
            amount: 20
          })
        });
        
        const transformData = await transformResponse.json();
        jobId = transformData.jobId;
        
        // Start polling for status
        startPolling();
      } catch (error) {
        console.error('Error starting transformation:', error);
        alert('Failed to start transformation. Please try again.');
        resetToUpload();
      }
    }
    
    // Poll job status
    function startPolling() {
      let progress = 0;
      let timeLeft = 75;
      
      pollInterval = setInterval(async () => {
        try {
          const response = await fetch(`${API_BASE_URL}/job-status/${jobId}`);
          const data = await response.json();
          
          // Update progress
          progress = Math.min(progress + 5, 95);
          progressBar.style.width = `${progress}%`;
          timeLeft = Math.max(timeLeft - 3, 0);
          timeRemaining.textContent = timeLeft;
          
          // Update status text
          if (progress < 30) {
            if (statusText) statusText.textContent = 'Analyzing your photo...';
            if (inlineOverlayText) inlineOverlayText.textContent = 'Analyzing your photoâ€¦';
          } else if (progress < 70) {
            if (statusText) statusText.textContent = 'Creating transformation...';
            if (inlineOverlayText) inlineOverlayText.textContent = 'Creating transformationâ€¦';
          } else {
            if (statusText) statusText.textContent = 'Almost ready...';
            if (inlineOverlayText) inlineOverlayText.textContent = 'Almost readyâ€¦';
          }
          
          // Check if completed
          if (data.status === 'completed') {
            clearInterval(pollInterval);
            progressBar.style.width = '100%';
            revealInline(data.originalUrl, data.resultUrl);
          } else if (data.status === 'failed') {
            clearInterval(pollInterval);
            alert(data.error || 'Transformation failed. Please try again.');
            resetToUpload();
          }
        } catch (error) {
          console.error('Error polling status:', error);
        }
      }, 3000); // Poll every 3 seconds
    }
    
    // Inline reveal
    function revealInline(original, result) {
      // Persist locally
      try {
        localStorage.setItem('lessfat_before', original || uploadedImageUrl);
        localStorage.setItem('lessfat_after', result);
      } catch {}
      if (inlineOverlayText) inlineOverlayText.textContent = 'Revealing your transformationâ€¦';
      const msg = document.getElementById('uploadMsg');
      if (msg) msg.textContent = 'Your preview is ready!';
      inlineAfterImage.classList.add('blur-20');
      inlineAfterImage.src = result;
      setTimeout(() => {
        inlineAfterImage.classList.remove('blur-20');
      }, 350);
      setTimeout(() => {
        inlineProcessingOverlay.classList.add('hidden');
        inlineActions.classList.remove('hidden');
      }, 900);
      // Keep results grid in sync (optional view)
      beforeImage.src = original || uploadedImageUrl;
      afterImage.src = result;
      if (jobId) fetch(`${API_BASE_URL}/job/${jobId}`, { method: 'DELETE' }).catch(() => {});
      // Inline actions
      downloadBtnInline.onclick = () => {
        const link = document.createElement('a');
        link.href = afterImage.src || inlineAfterImage.src || result;
        link.download = 'weight-loss-transformation.png';
        link.click();
      };
      tryAgainBtnInline.onclick = resetToUpload;
    }
    
    // Download result
    downloadBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.href = afterImage.src;
      link.download = 'weight-loss-transformation.png';
      link.click();
    });
    
    // Try again
    tryAgainBtn.addEventListener('click', resetToUpload);
    
    // Reset to upload
    function resetToUpload() {
      uploadedFile = null;
      uploadedImageUrl = null;
      jobId = null;
      if (pollInterval) clearInterval(pollInterval);
      try {
        localStorage.removeItem('lessfat_before');
        localStorage.removeItem('lessfat_after');
      } catch {}
      
      resultsSection.classList.add('hidden');
      processingSection.classList.add('hidden');
      uploadSection.classList.remove('hidden');
      
      uploadPrompt.classList.remove('hidden');
      uploadPreview.classList.add('hidden');
      previewImage.src = '';
      photoInput.value = '';
      progressBar.style.width = '0%';
      inlineProcessingOverlay.classList.add('hidden');
      inlineAfterImage.classList.remove('blur-20');
      inlineResultContainer.classList.add('hidden');
      inlineActions.classList.add('hidden');
    }
  </script>
</body>
</html>
